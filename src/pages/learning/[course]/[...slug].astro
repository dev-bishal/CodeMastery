---
import { getCollection, type CollectionEntry } from 'astro:content';
import MainLayout from '../../../layouts/MainLayout.astro';
import { courses } from '../../../data/courses';
import { authors } from '../../../data/authors';
import {getFormattedDate, getAdjacentElements} from "../../../data/utils"
import AuthorChip from '../../../components/AuthorChip.astro';
import Prose from "../../../components/Prose.astro"

let _allCodeArticles : CollectionEntry<"codeArticles">[] = await getCollection('codeArticles');
export async function getStaticPaths() {
    
    let allCodeArticles : CollectionEntry<"codeArticles">[] = await getCollection('codeArticles');
    // Map each article to a valid route
    return allCodeArticles.map((article) => {
        return {
            params: {
                course: article.filePath?.split("/")[2], // e.g., "javascript"
                slug: article.data.slug,    // e.g., "article-about-ai"
            },
            props: { article }, // Pass the full article data as a prop
        };
    });
}

const {article} = Astro.props;
const {course} = Astro.params;
const courseData = courses.find(obj => obj.slug === course);
let authorData :any[] = [];
article.data.author.map((articleAuthors)=>{
    authorData.push(authors.find(obj => obj.authorId === articleAuthors));
})

let listOfAllArticles : any[] = [];
_allCodeArticles.map((article)=>{
    listOfAllArticles.push(article.filePath);
})

let adjacentArticles = getAdjacentElements(listOfAllArticles, article.filePath);

console.log("Searching for", article.filePath);

console.log(adjacentArticles);
---
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">

<MainLayout 
    pageTitle={`${article.data.title}`} 
    description={article.data.metadescription}
    seoImagePath={article.data.featuredImage || ""}
    pageType='article'
>

    <!-- Main Content -->
    <main class="container mx-auto pt-24 px-6 py-8">
        <!-- Page Header -->
        <div class="mb-8 animate-on-scroll">
            <div class="flex items-center space-x-4 mb-4">
                <a href={`/CodeMastery/learning/${courseData?.slug}`} class="flex items-center text-purple-600 dark:text-purple-400">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span class="hover:underline">Back to Course</span>
                </a>
                <span class="px-3 py-1 rounded-full text-sm font-medium" class:list={[
                    article.data.level == 1 && "bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200",
                    article.data.level == 2 && "bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200",
                    article.data.level == 3 && "bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200"
                ]}>
                    {article.data.level == 1 && "Beginner"}
                    {article.data.level == 2 && "Intermediate"}
                    {article.data.level == 3 && "Advance"}
                </span>
                <span
                    class="px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full text-sm font-medium">
                    3 hours
                </span>
            </div>
    
            <div>
                <a href={`/CodeMastery/learning/${courseData?.slug}`}
                    class="font-medium hover:text-purple-600 dark:hover:text-purple-400 transition-colors">
                    {courseData?.courseTitle}
                </a>
                <span class="text-gray-400"> / </span>
                <h1 class="text-4xl md:text-5xl font-bold mb-4">{article.data.title}</h1>
            </div>
            <p class="text-xl text-gray-600 dark:text-gray-300 mb-6">{article.data.metadescription}</p>
    
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    {
                        authorData.map((author)=>(
                            <AuthorChip 
                                authorName = {author.authorName}
                                authorDesignation = {author.authorDesignation}
                                authorImage = {author.authorImageFileName}
                            /> 
                        ))
                    }
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        <i class="far fa-clock mr-1"></i>
                        Published on: {getFormattedDate(article.data.publishDate)}
                    </div>
                    {
                        getFormattedDate(article.data.updateDate) != getFormattedDate(article.data.publishDate) &&
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            <i class="far fa-clock mr-1"></i>
                            Last updated: {getFormattedDate(article.data.updateDate)}
                        </div>
                    }
                </div>
    
                <div class="flex items-center space-x-4">
                    <button id="mark-complete"
                        class="px-6 py-2 gradient-bg text-white font-medium rounded-lg hover:opacity-90 transition-opacity">
                        <i class="far fa-check-circle mr-2"></i>
                        Mark as Complete
                    </button>
                    <button
                        class="p-2 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <i class="far fa-bookmark"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <section class="flex flex-col lg:flex-row gap-8 mb-8">

            <!-- Main Content Area -->
            <div class="flex-1">
                <!-- Split Layout Container -->
                <div id="split-container" class="split-container flex flex-col lg:flex-row min-h-[calc(100vh-3.5rem)]">
                    <section class="w-full lg:w-1/2 p-8 lg:p-12 overflow-y-auto">
                        <div class="max-w-2xl mx-auto">
                            <span class="text-blue-600 font-semibold text-sm uppercase tracking-widest">
                                {article.data.level == 1 && "Beginner"}
                                {article.data.level == 2 && "Intermediate"}
                                {article.data.level == 3 && "Advance"}
                                Topic</span>
                            
                            <div class="content prose dark:prose-invert prose-slate max-w-none space-y-6">
                                <!-- Content will be here -->
                                 <Prose set:html={article.rendered?.html.split(`<code id="code-content"`)[0]}>
                                    
                                 </Prose>
                            </div>

                        </div>
                    </section>

                    <section class="rounded-xl w-full lg:w-1/2 bg-slate-950 p-6 lg:p-12 sticky top-14 overflow-hidden">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex gap-2">
                                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                <span class="text-xs text-slate-500 font-mono italic">script.js</span>
                            </div>
                            <div>
                                <button id="copy-code"
                                    class="cursor-pointer copy-btn px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                    <i class="far fa-copy mr-1"></i> Copy
                                </button>
                            </div>
                        </div>

                        <div class="h-full overflow-y-auto pb-20">
                            <pre class="rounded-xl !bg-transparent !m-0" set:html={`<code id="code-content"` + article.rendered?.html.split(`<code id="code-content"`)[`1`]}>
                                
                            </pre>
                        </div>
                    </section>
                </div>

                <!-- Next/Previous Navigation -->
                <div
                    class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-700 animate-on-scroll delay-200">
                    <a href="#"
                        class="flex items-center px-6 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-arrow-left mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Previous</p>
                            <p class="font-medium">Functions & Scope</p>
                        </div>
                    </a>

                    <a href="#"
                        class="flex items-center px-6 py-3 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-right">
                        <div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Next</p>
                            <p class="font-medium">Prototypes & Inheritance</p>
                        </div>
                        <i class="fas fa-arrow-right ml-3"></i>
                    </a>
                </div>

                <!-- Feedback Section -->
                <div class="pt-8 border-t border-gray-200 dark:border-gray-700 mt-10">
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-xl p-6">
                        <h3 class="text-xl font-bold mb-4">Was this explanation helpful?</h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-6">Your feedback helps us improve the content for
                            everyone.</p>

                        <div class="flex space-x-4 mb-6">
                            <button id="feedback-helpful"
                                class="feedback-btn flex-1 py-3 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-lg font-medium hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors">
                                <i class="far fa-thumbs-up mr-2"></i>
                                Helpful
                            </button>
                            <button id="feedback-not-helpful"
                                class="feedback-btn flex-1 py-3 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 rounded-lg font-medium hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
                                <i class="far fa-thumbs-down mr-2"></i>
                                Not Helpful
                            </button>
                        </div>

                        <div id="feedback-thankyou" class="hidden p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 text-xl mr-3"></i>
                                <div>
                                    <p class="font-bold text-green-700 dark:text-green-300">Thank you for your feedback!
                                    </p>
                                    <p class="text-green-600 dark:text-green-400 text-sm">We appreciate you helping us
                                        improve.</p>
                                </div>
                            </div>
                        </div>

                        <div id="feedback-comment" class="hidden mt-4">
                            <p class="text-gray-600 dark:text-gray-300 mb-3">What could we improve? (Optional)</p>
                            <textarea id="comment-text"
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900"
                                rows="3" placeholder="Your suggestions..."></textarea>
                            <button id="submit-comment"
                                class="mt-3 px-6 py-2 gradient-bg text-white font-medium rounded-lg hover:opacity-90 transition-opacity">
                                Submit Feedback
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </section>
        <span class="hidden bg-green-500 dark:bg-green-500"></span>
    </main>
    <!-- Prism.js for code highlighting -->
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

    <script is:inline>
        // Copy Code Button
        const copyButton = document.getElementById('copy-code');
        copyButton.addEventListener('click', function() {
            const codeContent = document.getElementById('code-content');
            const code = codeContent.textContent;
            navigator.clipboard.writeText(code).then(() => {
                const originalText = copyButton.innerHTML;
                copyButton.innerHTML = '<i class="fas fa-check mr-1"></i> Copied!';
                copyButton.classList.add('copied');
                copyButton.classList.add('bg-green-500');
                copyButton.classList.add('dark:bg-green-500');
                copyButton.classList.add('hover:bg-green-500');
                
                setTimeout(() => {
                    copyButton.innerHTML = originalText;
                    copyButton.classList.remove('copied');
                    copyButton.classList.remove('bg-green-500');
                    copyButton.classList.remove('dark:bg-green-500');
                    copyButton.classList.remove('hover:bg-green-500');
                }, 2000);
            });
        });

        // Initialize Prism highlighting
        document.addEventListener('DOMContentLoaded', () => {
            Prism.highlightAll();

            // Initialize animations
            setTimeout(() => {
                animateOnScroll();
            }, 100);
        });
    </script>
</MainLayout>